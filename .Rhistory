lat_era  <- ncvar_get(obsrp, "latitude")
time_era <- ncvar_get(obsrp, "time")
lon_obsrp  <- ncvar_get(obsrp, "longitude")
lat_obsrp  <- ncvar_get(obsrp, "latitude")
time_obsrp <- ncvar_get(obsrp, "time")
names(obsrp)
names(obsrp$var)
names(obsrp$nvars)
names(obsrp$dim)
time_obsrp <- ncvar_get(obsrp, "valid_time")
# 3) گرفتن میدان‌های u10 و v10
u10 <- ncvar_get(obsrp, "u10")
v10 <- ncvar_get(obsrp, "v10")
# 4) محاسبهٔ سرعت باد در هر سلول و هر زمان
ws_array <- sqrt(u10^2 + v10^2)
# 5) میانگین گرفتن روی همه سلول‌های باکس برای هر زمان
# (یعنی برای هر ماه یک عدد متوسط)
ws_obsrp <- apply(ws_array, 3, mean, na.rm = TRUE)
# 6) تبدیل time به تاریخ
time_units_obsrp <- ncatt_get(obsrp, "time", "units")$value
# 6) تبدیل time به تاریخ
time_units_obsrp <- ncatt_get(obsrp, "valid_time", "units")$value
print(time_units_obsrp)
names(obsrp$dim)
# 2) پیدا کردن بُعدی که واحد زمان دارد (کلمه "since" در units)
time_dim_list <- Filter(
function(d) !is.null(d$units) && grepl("since", d$units),
obsrp$dim
)
length(time_dim_list)  # باید 1 باشد
time_dim   <- time_dim_list[[1]]
time_vals  <- time_dim$vals
time_units <- time_dim$units
time_units        # این همان "seconds since 1970-01-01" است
head(time_vals)   # چند تا عدد اول
# 3) تبدیل این ثانیه‌ها به تاریخ
origin <- as.POSIXct("1970-01-01 00:00:00", tz = "UTC")
dates_era <- origin + time_vals   # چون واحد = ثانیه است
dates_era <- as.Date(dates_era)
# 4) چند تاریخ اول و آخر را ببین
head(dates_era)
tail(dates_era)
nc_close(obsrp)
rm(list=ls())
# 2) گرفتن مختصات و زمان
lon_obsrp  <- ncvar_get(obsrp, "longitude")
obsrp <- nc_open("C:/Users/arefe/Desktop/Personal Folder/My_Projects/downscaling/downscaling/obsrp/data_stream-moda_stepType-avgua.nc")
names(obsrp$var)
datagp <- rast("C:/Users/arefe/Desktop/Personal Folder/My_Projects/downscaling/downscaling/datagp/sfcWind_Amon_IPSL-CM6A-LR_historical_r1i1p1f1_gr_19800116-19991216.nc")
datagf <- rast("C:/Users/arefe/Desktop/Personal Folder/My_Projects/downscaling/downscaling/datagf/sfcWind_Amon_IPSL-CM6A-LR_historical_r1i1p1f1_gr_20000116-20141216.nc")
# 2) گرفتن مختصات و زمان
lon_obsrp  <- ncvar_get(obsrp, "longitude")
lat_obsrp  <- ncvar_get(obsrp, "latitude")
time_obsrp <- ncvar_get(obsrp, "valid_time")
# 3) گرفتن میدان‌های u10 و v10
u10 <- ncvar_get(obsrp, "u10")
v10 <- ncvar_get(obsrp, "v10")
# 4) محاسبهٔ سرعت باد در هر سلول و هر زمان
ws_array <- sqrt(u10^2 + v10^2)
# 5) میانگین گرفتن روی همه سلول‌های باکس برای هر زمان
# (یعنی برای هر ماه یک عدد متوسط)
ws_obsrp <- apply(ws_array, 3, mean, na.rm = TRUE)
# 6) تبدیل time به تاریخ
time_units_obsrp <- ncatt_get(obsrp, "valid_time", "units")$value
print(time_units_obsrp)
origin_obsrp <- as.POSIXct("1900-01-01 00:00:00", tz = "UTC")
origin_obsrp <- as.POSIXct("1970-01-01 00:00:00", tz = "UTC")
dates_obsrp  <- origin_obsrp + time_obsrp
dates_obsrp  <- as.Date(dates_obsrp)
head(time_obsrp)
head(dates_obsrp)
range(dates_obsrp)
nc_close(obsrp)
# 8) ساختن دیتافریم ساده
df_obsrp <- data.frame(date = dates_obsrp, ws = ws_obsrp)
df_obsrp
# چک اولیه
head(df_obsrp)
summary(df_obsrp$ws)
ts.plot(df_obsrp)
ts.plot(df_obsrp$ws)
plot(df_obsrp$date,df_obsrp$ws)
plot(df_obsrp$date,df_obsrp$ws, type = "l")
# 2) گرفتن مختصات و زمان
lon_datagp  <- ncvar_get(datagp, "longitude")
datagp <- nc_open("C:/Users/arefe/Desktop/Personal Folder/My_Projects/downscaling/downscaling/datagp/sfcWind_Amon_IPSL-CM6A-LR_historical_r1i1p1f1_gr_19800116-19991216.nc")
datagf <- nc_open("C:/Users/arefe/Desktop/Personal Folder/My_Projects/downscaling/downscaling/datagf/sfcWind_Amon_IPSL-CM6A-LR_historical_r1i1p1f1_gr_20000116-20141216.nc")
# 2) گرفتن مختصات و زمان
lon_datagp  <- ncvar_get(datagp, "longitude")
datagp
# 2) گرفتن مختصات و زمان
lon_datagp  <- ncvar_get(datagp, "longitude")
names(datagp$var)
names(datagp$dim)
# 2) گرفتن مختصات و زمان
lon_datagp  <- ncvar_get(datagp, "lon")
lat_datagp  <- ncvar_get(datagp, "lat")
time_datagp <- ncvar_get(datagp, "time")
# 3) گرفتن میدان‌های u10 و v10
u10 <- ncvar_get(datagp, "u10")
names(datagp$dim)
print(datagp)
names(datagp$dim)
names(datagp$var)
ws_gp <- ncvar_get(datagp, "sfcWind")   # ابعاد: lon × lat × time
# --- بررسی ابعاد ---
print(dim(ws_gp))       # انتظار: nlon × nlat × ntime
print(length(time_datagp))
# --- تبدیل واحد زمان ---
time_units_gp <- ncatt_get(datagp, "time", "units")$value
print(time_units_gp)
# --- تبدیل واحد زمان ---
time_units_gp <- ncatt_get(datagp, "time", "units")$value
print(time_units_gp)
origin_gp <- as.POSIXct("1850-01-01 00:00:00", tz = "UTC")
time_units_gp <- ncatt_get(datagp, "time", "units")$value
print(time_units_gp)
origin_gp <- as.POSIXct("1850-01-01 00:00:00", tz = "UTC")
dates_gp  <- origin_gp + time_datagp * 86400   # 86400 ثانیه = 1 روز
dates_gp  <- as.Date(dates_gp)
ws_gp_mean <- apply(ws_gp, 3, mean, na.rm = TRUE)
dim(ws_gp)
datagp$var$sfcWind$dimids
datagp$dim
dim(ws_gp)
# 2) خواندن مختصات و زمان و متغیر باد سطحی
lon_datagp  <- ncvar_get(datagp, "lon")
lat_datagp  <- ncvar_get(datagp, "lat")
time_datagp <- ncvar_get(datagp, "time")
ws_gp       <- ncvar_get(datagp, "sfcWind")   # dim باید 75 x 240 باشد
dim(ws_gp)          # برای کنترل
length(time_datagp) # انتظار: 240
# 3) تبدیل time -> تاریخ، بر اساس units در فایل
time_units_gp <- ncatt_get(datagp, "time", "units")$value
print(time_units_gp)
# معمولاً چیزی مثل "days since 1850-01-01" است
# استخراج unit و origin از رشته‌ی units
parts      <- strsplit(time_units_gp, " since ")[[1]]
time_unit  <- parts[1]   # مثلا "days"
origin_str <- parts[2]   # مثلا "1850-01-01"
origin_gp <- as.POSIXct(paste0(origin_str, " 00:00:00"), tz = "UTC")
mult <- switch(time_unit,
"days"    = 86400,
"day"     = 86400,
"hours"   = 3600,
"hour"    = 3600,
"seconds" = 1,
"second"  = 1,
1)
dates_gp <- origin_gp + time_datagp * mult
dates_gp <- as.Date(dates_gp)
# 4) میانگین روی بعد مکانی برای هر زمان → سری زمانی
#   ws_gp: [space, time] = [75, 240]
ws_gp_mean <- colMeans(ws_gp, na.rm = TRUE)  # یا apply(ws_gp, 2, mean, na.rm = TRUE)
length(ws_gp_mean)  # باید = 240
length(dates_gp)    # باید = 240
# 5) ساختن دیتافریم سری زمانی
df_gp <- data.frame(
date = dates_gp,
ws   = ws_gp_mean
)
head(df_gp)
summary(df_gp$ws)
# 6) بستن فایل
nc_close(datagp)
ts.plot(df_gp$ws)
## 1) خواندن مختصات، زمان و باد سطحی از datagf
lon_datagf  <- ncvar_get(datagf, "lon")
lat_datagf  <- ncvar_get(datagf, "lat")
time_datagf <- ncvar_get(datagf, "time")
ws_gf       <- ncvar_get(datagf, "sfcWind")   # ابعاد: space × time (مثلاً 75 × N)
# کنترل ابعاد
dim(ws_gf)
length(time_datagf)
## 2) تبدیل time → تاریخ، با استفاده از units داخل فایل
time_units_gf <- ncatt_get(datagf, "time", "units")$value
print(time_units_gf)
# مثلاً: "days since 1850-01-01"
# جدا کردن واحد و مبدأ از رشته‌ی units
parts_gf   <- strsplit(time_units_gf, " since ")[[1]]
time_unit_gf  <- parts_gf[1]   # "days" یا "hours" یا "seconds"
origin_str_gf <- parts_gf[2]   # مثلاً "1850-01-01"
origin_gf <- as.POSIXct(paste0(origin_str_gf, " 00:00:00"), tz = "UTC")
# ضریب تبدیل بر اساس واحد
mult_gf <- switch(time_unit_gf,
"days"    = 86400,
"day"     = 86400,
"hours"   = 3600,
"hour"    = 3600,
"seconds" = 1,
"second"  = 1,
1)
dates_gf <- origin_gf + time_datagf * mult_gf
dates_gf <- as.Date(dates_gf)
## 3) میانگین روی بعد مکانی برای هر زمان → سری زمانی آینده
# ws_gf: [space, time] = [nspace, ntime]
ws_gf_mean <- colMeans(ws_gf, na.rm = TRUE)  # یا apply(ws_gf, 2, mean, na.rm = TRUE)
length(ws_gf_mean)  # باید = length(time_datagf)
length(dates_gf)    # باید = length(time_datagf)
## 4) ساختن دیتافریم سری زمانی آینده
df_gf <- data.frame(
date = dates_gf,
ws   = ws_gf_mean
)
head(df_gf)
summary(df_gf$ws)
## 5) بستن فایل
nc_close(datagf)
print(time_units_gf)
ts.plot(df_gf$ws)
str(df_obs)
str(df_obsrp)
# 'data.frame':  N1 obs. of  2 variables:
# $ date: Date
# $ ws  : num
str(df_gp)
str(df_gf)
time_datagf
head(df_gf)
head(df_obsrp)
head(df_gp)
?hist_join
??hist_join
str(df_obs)
str(df_obsrp)
# 'data.frame':  N1 obs. of  2 variables:
# $ date: Date
# $ ws  : num
str(df_gp)
str(df_gf)
library(dplyr)
install.packages('dplyr')
library(dplyr)
hist_start <- as.Date("1980-01-01")
hist_end   <- as.Date("1999-12-31")
obs_hist <- df_obs %>%
filter(date >= hist_start, date <= hist_end) %>%
arrange(date)
obs_hist <- df_obsrp %>%
filter(date >= hist_start, date <= hist_end) %>%
arrange(date)
gp_hist <- df_gp %>%
filter(date >= hist_start, date <= hist_end) %>%
arrange(date)
nrow(obs_hist)
nrow(gp_hist)
head(obs_hist$date)
head(gp_hist$date)
tail(obs_hist$date)
tail(gp_hist$date)
hist_join <- inner_join(
obs_hist %>% rename(ws_obs = ws),
gp_hist  %>% rename(ws_gp  = ws),
by = "date"
)
nrow(hist_join)   # تعداد ماه‌های مشترک
head(hist_join)
ws_obs
obs_hist
df_obsrp  # داده محلی (ERA5/obs)
df_gp     # داده GCM historical
head(df_obsrp)
# date      ws   (مثلاً 1980-01-01, 1980-02-01, ...)
head(df_gp)
# date      ws   (مثلاً 1980-01-16, 1980-02-15, ...)
range(df_obsrp$date)
range(df_gp$date)
obs_hist <- df_obsrp %>%
mutate(
year  = year(date),
month = month(date)
)
??mutate
??year
install.packages("lubritude")
library(lubritude)
install.packages("lubridate")
library(lubridate)
obs_hist <- df_obsrp %>%
mutate(
year  = year(date),
month = month(date)
)
gp_hist <- df_gp %>%
mutate(
year  = year(date),
month = month(date)
)
head(obs_hist)
head(gp_hist)
hist_join <- inner_join(
obs_hist %>% select(year, month, ws_obs = ws),
gp_hist  %>% select(year, month, ws_gp  = ws),
by = c("year", "month")
)
nrow(hist_join)
head(hist_join)
hist_join <- hist_join %>%
mutate(date_month = as.Date(paste(year, month, "01", sep = "-"))) %>%
arrange(date_month)
gf_fut <- df_gf %>%
arrange(date)
gf_fut <- df_gf %>%
filter(date >= as.Date("2030-01-01"),
date <= as.Date("2050-12-31")) %>%
arrange(date)
head(gf_fut)
gf_fut <- df_gf %>%
arrange(date)
gf_fut <- df_gf %>%
filter(date >= as.Date("2030-01-01"),
date <= as.Date("2050-12-31")) %>%
arrange(date)
head(gf_fut)
nrow(df_gf)
head(df_gf)
tail(df_gf)
range(df_gf$date)
gf_fut <- df_gf %>%
arrange(date)
head(gf_fut)
tail(gf_fut)
nrow(gf_fut)
range(gf_fut$date)
ObsRp  <- hist_join$ws_obs   # مشاهدات محلی در دورهٔ مرجع
DataGp <- hist_join$ws_gp    # GCM historical در دورهٔ مرجع
DataGf <- gf_fut$ws          # GCM «آینده» 2000–2014
length(ObsRp)    # مثلاً 240
length(DataGp)   # باید برابر با ObsRp
length(DataGf)   # طول آینده، مثلاً 180 (15 سال × 12 ماه)
install.packages("CDFt")   # فقط یک‌بار
install.packages("CDFt")
library(CDFt)
res_cdft <- CDFt(ObsRp, DataGp, DataGf)
str(res_cdft)
ws_fut_bc <- res_cdft$DS   # سری آیندهٔ bias-corrected
length(ws_fut_bc)   # باید = length(gf_fut$ws)
length(gf_fut$ws)
df_gf_bc <- data.frame(
date = gf_fut$date,  # همان تاریخ‌های 2000–2014
ws   = ws_fut_bc     # سرعت باد downscaled
)
head(df_gf_bc)
summary(df_gf_bc$ws)
library(ggplot2)
install.packages("ggplot2")
df_plot_fut <- data.frame(
date = gf_fut$date,
gp_raw = gf_fut$ws,
gp_bc  = ws_fut_bc
)
ggplot(df_plot_fut, aes(x = date)) +
geom_line(aes(y = gp_raw), linetype = "dashed") +
geom_line(aes(y = gp_bc))
library(ggplot2)
df_plot_fut <- data.frame(
date = gf_fut$date,
gp_raw = gf_fut$ws,
gp_bc  = ws_fut_bc
)
ggplot(df_plot_fut, aes(x = date)) +
geom_line(aes(y = gp_raw), linetype = "dashed") +
geom_line(aes(y = gp_bc))
x   <- res_cdft$x
FRp <- res_cdft$FRp
FGp <- res_cdft$FGp
FGf <- res_cdft$FGf
FRf <- res_cdft$FRf
plot(x, FGp, type = "l", lty = 2, ylim = c(0, 1), xlab = "ws", ylab = "CDF")
lines(x, FGf, lty = 2, col = 2)
lines(x, FRp)
lines(x, FRf, col = 2)
legend("bottomright",
legend = c("GCM hist", "GCM fut", "Obs hist", "Downscaled fut CDF"),
lty = c(2, 2, 1, 1),
col = c(1, 2, 1, 2),
bty = "n")
head(res_cdft$DS)
str(res_cdft)
ds_val <- res$DS
dates_gf <- df_gf$date   # تاریخ‌هایی که از CMIP6 برای این دوره داری
ds_val <- res_cdft$DS
dates_gf <- df_gf$date   # تاریخ‌هایی که از CMIP6 برای این دوره داری
df_downscaled <- data.frame(
date = dates_gf,
ws_ds = ds_val
)
head(df_downscaled)
tail(df_downscaled)
obsval <- nc_open("C:/Users/arefe/Desktop/Personal Folder/My_Projects/downscaling/downscaling/obsval/data_stream-moda_stepType-avgua.nc")
names(obsval$var)
# 2) گرفتن مختصات و زمان
lon_obsval  <- ncvar_get(obsval, "longitude")
lat_obsval  <- ncvar_get(obsval, "latitude")
time_obsval <- ncvar_get(obsval, "valid_time")
# 3) گرفتن میدان‌های u10 و v10
u10 <- ncvar_get(obsval, "u10")
v10 <- ncvar_get(obsval, "v10")
# 4) محاسبهٔ سرعت باد در هر سلول و هر زمان
ws_array <- sqrt(u10^2 + v10^2)
# 5) میانگین گرفتن روی همه سلول‌های باکس برای هر زمان
# (یعنی برای هر ماه یک عدد متوسط)
ws_obsval <- apply(ws_array, 3, mean, na.rm = TRUE)
# 6) تبدیل time به تاریخ
time_units_obsval <- ncatt_get(obsval, "valid_time", "units")$value
print(time_units_obsval)
origin_obsval <- as.POSIXct("1970-01-01 00:00:00", tz = "UTC")
dates_obsval  <- origin_obsval + time_obsval
dates_obsval  <- as.Date(dates_obsval)
# 7) بستن فایل
nc_close(obsval)
# 8) ساختن دیتافریم ساده
df_obsval <- data.frame(date = dates_obsval, ws = ws_obsval)
# چک اولیه
head(df_obsval)
summary(df_obsval$ws)
down_scaled <- df_downscaled %>%
mutate(
year  = year(date),
month = month(date)
)
down_scaled
obs_val <- df_obsval %>%
mutate(
year  = year(date),
month = month(date)
)
val_join <- inner_join(
down_scaled %>% select(year, month, ws_ds = ws_ds),
obs_val     %>% select(year, month, ws_obs = ws),
by = c("year", "month")
)
head(val_join)
MAE  <- val_join %>% summarise(mae  = mean(abs(ws_ds - ws_obs))) %>% pull(mae)
RMSE <- val_join %>% summarise(rmse = sqrt(mean((ws_ds - ws_obs)^2))) %>% pull(rmse)
MAE
RMSE
gcm_val <- df_gcm_val %>%
mutate(
year  = year(date),
month = month(date)
)
cdf_ds  <- ecdf(df_downscaled$ws_ds)
cdf_obs <- ecdf(df_obsval$ws)
ks <- ks.test(df_downscaled$ws_ds, df_obsval$ws)
ks$statistic   # مقدار KS
ks$p.value     # p-value
install.packages("goftest")
library(goftest)
cvm <- cvm.test(df_downscaled$ws_ds, null = df_obsval$ws)
cvm_res <- cramer.test(df_downscaled$ws_ds, df_obsval$ws)
library(cramer)
install.packages("cramer")
library(cramer)
cvm_res <- cramer.test(df_downscaled$ws_ds, df_obsval$ws)
cvm_res
+ **ObsRp**: A vector of observed time series at the local scale, used to estimate the calibration local-scale CDF ($F_{Sh}$). In this project, ERA5 reanalysis data serves as a proxy for ObsRp due to the unavailability of direct local wind speed measurements at the Saint-Nazaire Offshore Wind Farm.
lon_obsrp  <- ncvar_get(obsrp, "longitude")
# 7) بستن فایل
nc_close(obsrp)
obsrp <- nc_open("C:/Users/arefe/Desktop/Personal Folder/My_Projects/downscaling/downscaling/obsrp/data_stream-moda_stepType-avgua.nc")
# 7) بستن فایل
nc_close(obsrp)
nc_close(obsrp)
nc_close(obsval)
nc_close(datagp)
nc_close(datagf)
obsrp <- nc_open("C:/Users/arefe/Desktop/Personal Folder/My_Projects/downscaling/downscaling/obsrp/data_stream-moda_stepType-avgua.nc")
library(ncdf4)
obsrp <- nc_open("C:/Users/arefe/Desktop/Personal Folder/My_Projects/downscaling/downscaling/obsrp/data_stream-moda_stepType-avgua.nc")
datagp <- nc_open("C:/Users/arefe/Desktop/Personal Folder/My_Projects/downscaling/downscaling/datagp/sfcWind_Amon_IPSL-CM6A-LR_historical_r1i1p1f1_gr_19800116-19991216.nc")
datagf <- nc_open("C:/Users/arefe/Desktop/Personal Folder/My_Projects/downscaling/downscaling/datagf/sfcWind_Amon_IPSL-CM6A-LR_historical_r1i1p1f1_gr_20000116-20141216.nc")
obsval <- nc_open("C:/Users/arefe/Desktop/Personal Folder/My_Projects/downscaling/downscaling/obsval/data_stream-moda_stepType-avgua.nc")
# 2) گرفتن مختصات و زمان
lon_obsrp  <- ncvar_get(obsrp, "longitude")
lat_obsrp  <- ncvar_get(obsrp, "latitude")
range(lon_obsrp)
range(lat_obsrp)
time_obsrp <- ncvar_get(obsrp, "valid_time")
# 3) گرفتن میدان‌های u10 و v10
u10 <- ncvar_get(obsrp, "u10")
v10 <- ncvar_get(obsrp, "v10")
# 4) محاسبهٔ سرعت باد در هر سلول و هر زمان
ws_array <- sqrt(u10^2 + v10^2)
# 5) میانگین گرفتن روی همه سلول‌های باکس برای هر زمان
# (یعنی برای هر ماه یک عدد متوسط)
ws_obsrp <- apply(ws_array, 3, mean, na.rm = TRUE)
# 6) تبدیل time به تاریخ
time_units_obsrp <- ncatt_get(obsrp, "valid_time", "units")$value
print(time_units_obsrp)
origin_obsrp <- as.POSIXct("1970-01-01 00:00:00", tz = "UTC")
dates_obsrp  <- origin_obsrp + time_obsrp
dates_obsrp  <- as.Date(dates_obsrp)
# 7) بستن فایل
nc_close(obsrp)
# 8) ساختن دیتافریم ساده
df_obsrp <- data.frame(date = dates_obsrp, ws = ws_obsrp)
# چک اولیه
head(df_obsrp)
lon_datagp  <- ncvar_get(datagp, "lon")
lat_datagp  <- ncvar_get(datagp, "lat")
range(lon_datagp)
range(lat_datagp)
lon_datagp  <- ncvar_get(datagp, "lon")
lat_datagp  <- ncvar_get(datagp, "lat")
range(lon_datagp)
range(lat_datagp)
47.16+0.5
47.16-0.5
24*60*60
install.packages("viridis")
install.packages("tidyr")
